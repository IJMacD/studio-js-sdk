<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>calendar.js - i-Learner Studio Admin API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="i-Learner Studio Admin API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Course.html">Course</a></li>
            
                <li><a href="../classes/Lesson.html">Lesson</a></li>
            
                <li><a href="../classes/Report.html">Report</a></li>
            
                <li><a href="../classes/Room.html">Room</a></li>
            
                <li><a href="../classes/Tutor.html">Tutor</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Calendar.html">Calendar</a></li>
            
                <li><a href="../modules/Core.html">Core</a></li>
            
                <li><a href="../modules/Report.html">Report</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: calendar.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function(window){

	/**
	 * Calendar module. Contains Lesson and Course classes.
	 *
	 * @module Calendar
	 */
	var iLearner = window.iLearner || {},
		Calendar = {},
		Lesson = {},
		Course = {},

		/* Constants */
		levelRegex = /\s*\w\d(?:\s?-\s?\w\d)?\s*/i,
		customLevels = [
			{regex: /Trinity/, level: &quot;K&quot;},
			{regex: /GCSE/, level: &quot;S&quot;},
			{regex: /St\. Mary/, level: &quot;P&quot;},
			{regex: /DSE/, level: &quot;S&quot;},
			{regex: /Starters|Movers|Flyers/, level: &quot;K&quot;}
		],

		/* data */
		courses = {},
		lessons = {};

	window.iL = iLearner;
	iLearner.Lesson = Lesson;
	iLearner.Course = Course;
	/* @deprecated */
	iLearner.Calendar = Calendar;

	/**
	 * Lesson class for dealing with lesson instances happening
	 * at a specific time on a specific date
	 *
	 * @class Lesson
	 */

	/**
	 * Get a lesson specified by its ID
	 *
	 * @method get
	 * @param id {int} Lesson ID
	 * @return {object} Object representing the lesson
	 */
	function getLesson(id){
		return lessons[id];
	}
	Lesson.get = getLesson;

	/**
	 * Find a lesson with specific conditions
	 *
	 * @method find
	 * @param options {object} A map of options
	 * @param options.start {Date} Only return lessons which start after this date
	 * @param [options.tutor] {object} Restrict lessons to only those taught by the
	 * specified tutor
	 * @return {Promise} Promise of an array of lesson objects
	 */
	function findLessons(options){
		options = $.isPlainObject(options) ? options : {
            start: new Date()
        };
		var	post_data = {
				sDate: iL.formatDate(options.start)
			};
		if(options.tutor){
			post_data.Tutor = options.tutor.id;
		}
        return Promise.resolve(
            $.post(iL.API_ROOT + &#x27;process_getCalendarData.php&#x27;,
                post_data,
                null,
                &quot;json&quot;)
            ).then(function(data){
				var lesson_ids = [],
					events = [];

				$.each(data.CalendarCourse, function(i,item){
					var start = new Date(item.ScheduleDate),
						end = new Date(item.ScheduleDate),
						tutor = iL.findTutor(item.Tutor, true),
						level = item.Coursetitle.match(levelRegex),
						courseTitle = item.Coursetitle.replace(levelRegex, &quot;&quot;),

						course = {
							id: item.CourseID,
							code: item.CourseName,
							title: courseTitle,
							level: null,
							day: start.getDay(),
							startTime: item.Starttime,
							endTime: item.endtime,
							tutor: tutor,
							lessons: []
						},
						lesson = {
							id: item.CourseScheduleID,
							start: start,
							end: end,
							room: iL.findRoom(item.Location),
							tutor: tutor,
							students: []
						},

						_lessons;

					_setTime(start, item.Starttime);
					_setTime(end, item.endtime);

					level = level &amp;&amp; level[0].replace(&quot; &quot;, &quot;&quot;);
					if(!level){
						$.each(customLevels, function(i,cItem){
							if(cItem.regex.test(courseTitle)){
								level = cItem.level;
								return false;
							}
						});
					}
					course.level = level;

					// TODO: This is wasteful, find elegant way to merge
					if(courses[course.id]){
						course = courses[course.id];
					}
					else {
						courses[course.id] = course;
					}

					// TODO: This is wasteful, find elegant way to merge
					if(lessons[lesson.id]){
						lesson = lessons[lesson.id];
						lesson.students.length = 0;
					}
					else {
						lessons[lesson.id] = lesson;
						lesson.course = course;
						course.lessons.push(lesson);
					}
					lesson_ids.push(lesson.id);

					// lesson is about to get loaded with its known students
					// so it is safe to set and immediatly resolve the deferred
					// (no one has access to this object yet)
					//  - OK not strictly true if it already existed
					lesson._students = $.Deferred();
					lesson._students.resolve(lesson.students);

					// If we don&#x27;t care about empty lessons just add the lesson
					// to the result set now; otherwise wait until later and add
					// after being checked.
					if(options.showEmpty){
						events.push(lesson);
					}
				});

				$.each(data.CalendarStudent, function(i,item){
					var student = {
							id: item.MemberID,
							name: item.nickname,
							photo: item.Accountname,
							absent: item.Attendance == &quot;0&quot;
						},
						lesson = lessons[item.CourseScheduleID];
					iL.Util.parseName(student);
					lesson &amp;&amp; lesson.students.push(student);
				});

				if(!options.showEmpty){
					$.each(lesson_ids, function(i,item){
						var lesson = lessons[item];
						if(lesson.students.length){
							events.push(lesson);
						}
					});
				}

				return events;
			});
	}
	Lesson.find = findLessons;
	/* @deprecated */	
	Lesson.search = findLessons;
	/* @deprecated */
	Calendar.get = findLessons;
	/* @deprecated */
	Calendar.getLessons = findLessons;

	/**
	 * Save lesson changes back to the server
	 *
	 * @method save
	 * @param lesson {object} lesson object
	 * @return {Promise} Promise of completion
	 */
	function save(lesson){
		var startHour = lesson.start.getHours(),
			endHour = lesson.end.getHours(),
			startAP = startHour &lt; 12 ? &quot;AM&quot; : &quot;PM&quot;,
			endAP = endHour &lt; 12 ? &quot;AM&quot; : &quot;PM&quot;,
			post_data = {
				Action: &quot;update&quot;,
				insertMode: null,
				tid: lesson.tutor.id,
				cstatus:0,
				courseID: lesson.course.id,
				coursescheduleID: lesson.id,
				cssid: lesson.course.id,	// Duplicated Course ID, old and new possibly?
				csid: lesson.room.id,		// Classroom ID
				sdate: iL.formatDate(lesson.start),
				timefrom: pad(startHour),	// Yes, these *must* be padded strings and 24-hour!
				minutesfrom: pad(lesson.start.getMinutes()),
				fromdt: startAP,			// Not sure if required
				timeto: pad(endHour),		// Yes, these *must* be padded strings and 24-hour!
				minutesto: pad(lesson.end.getMinutes()),
				todt: endAP,				// Not sure if required
				mon:0,
				tue:0,
				wed:0,
				thu:0,
				fri:0,
				sat:0,
				sun:0,
				coursetypechanged:0,
				orignal_coursetype:0
			},
			deferred = $.Deferred();
		$.post(iL.API_ROOT + &#x27;process_updateCourseSchedule.php&#x27;,
			post_data,
			function(data){
				if(data.statuscode == 1){
					deferred.resolve();
				}
				else {
					deferred.reject();
				}
			},
			&quot;json&quot;).fail(deferred.reject);
		return deferred.promise();
	}
	Lesson.save = save;
	/* @deprecated */
	Calendar.save = save;

	/**
	 * Get previous lesson in series of course
	 *
	 * @method prev
	 * @param lesson {object}
	 * @return {Promise} Promise of lesson object
	 */
	function previousLesson(lesson){
		if(!lesson._prev){
			lesson._prev = $.Deferred();
			Course.lessons(lesson.course).done(function(lessons){
				var index = lessons.indexOf(lesson);
				lesson._prev.resolve(lessons[index-1]);
			});
		}
		return lesson._prev.promise();
	}
	Lesson.prev = previousLesson;

	/**
	 * Get next lesson in series of course
	 *
	 * @method next
	 * @param lesson {object}
	 * @return {Promise} Promise of a lesson
	 */
	function nextLesson(lesson){
		if(!lesson._next){
			lesson._next = $.Deferred();
			Course.lessons(lesson.course).done(function(lessons){
				var index = lessons.indexOf(lesson);
				lesson._next.resolve(lessons[index+1]);
			});
		}
		return lesson._next.promise();
	}
	Lesson.next = nextLesson;

	/**
	 * Get a collection of all future lessons of the same course
	 *
	 * @method future
	 * @param lesson {object}
	 * @return {Promise} Promise of an array of lessons
	 */
	function futureLessons(lesson){
		if(!lesson._future){
			lesson._future = $.Deferred();
			Course.lessons(lesson.course).done(function(lessons){
				var index = lessons.indexOf(lesson);
				lesson._future.resolve(lessons.slice(index));
			});
		}
		return lesson._future.promise();
	}
	Lesson.future = futureLessons;

	/**
	 * Get details of the students registered for a lesson
	 *
	 * @method students
	 * @param lesson {object}
	 * @return {Promise} An array of students
	 */
	function lessonStudents(lesson){
		if(!lesson._students){
			lesson._students = new Promise(function(resolve, reject){
				$.post(iL.API_ROOT + &quot;process_getCourseScheduleStudents.php&quot;,
					{
						scheduleID: lesson.id
					},
					function(data){
						if(!lesson.students){
							lesson.students = [];
						}
						lesson.students.length = 0;
						$.each(data.coursestudent, function(i,item){
							var student = {
									id: item.MemberID,
									name: item.Lastname,
									photo: item.Accountname,
									absent: item.absent == &quot;1&quot;
								};
							iL.Util.parseName(student);
							lesson.students.push(student);
						});
						resolve(lesson.students);
					},
					&quot;json&quot;)
				.fail(reject);
			});
		}
		return lesson._students;
	}
	Lesson.students = lessonStudents;

	/**
	 * Class to deal with courses. Courses generally run for a number of weeks
	 * and contain lesson instances
	 *
	 * @class Course
	 */

	/**
	 * Get a specific course
	 *
	 * @method get
	 * @param id {int} ID of course to get
	 * @return {object} Course object
	 */
	function getCourse(id){
		return courses[id];
	}
	Course.get = getCourse;

	/**
	 * Get all lessons for this course
	 *
	 * @method lessons
	 * @param course {object}
	 * @return {Promise} Promise of an array
	 */
	function courseLessons(course){
		if(!course._lessons){
			course._lessons = Promise.resolve(
				$.post(iL.API_ROOT + &quot;process_getCourseDetail.php&quot;,
					{
						courseID: course.id
					},
                    null,
                    &quot;json&quot;)
                )
                .then(function(data){
                    if(!course.lessons){
                        course.lessons = [];
                    }

                    $.each(data.coursedetailschedule, function(i,item){
                        if(lessons[item.CourseScheduleID]){
                            return;
                        }

                        var start = new Date(item.ScheduleDate),
                            end = new Date(item.ScheduleDate),
                            lesson = {
                                id: item.CourseScheduleID,
                                start: start,
                                end: end,
                                room: iL.Room.get(item.ClassroomID),
                                tutor: iL.Tutor.get(item.TutorMemberID),
                                course: course,
                                students: []
                            };

                        _setTime(start, item.Starttime);
                        _setTime(end, item.Endtime);

                        course.lessons.push(lesson);

                    });

                    course.lessons.sort(function(a,b){
                        return a.start.getTime() &lt; b.start.getTime() ? -1 : 1;
                    });

                    return course.lessons;
			    });
		}
		return course._lessons;
	}
	Course.lessons = courseLessons;

	function pad(s){return (s&lt;10)?&quot;0&quot;+s:s}

	function _setTime(date, time){
		date.setHours(time.substr(0,2));
		date.setMinutes(time.substr(2,2));
	}

}(window));

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
