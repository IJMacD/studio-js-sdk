<link rel="stylesheet" href="qunit-1.14.0.css" />
<script src="qunit-1.14.0.js"></script>
<script src="jquery-2.1.0.min.js"></script>
<script src="spark-md5.js"></script>
<script src="../conf.js"></script>
<script src="../core.js"></script>
<script src="../report.js"></script>
<script src="../calendar.js"></script>
<script>
asyncTest("Login", function(){
	expect(2);

	iL.Login("tutor", "itutor123")
		.then(function(){
			ok(true, "Login successful");
			start();
		})
		.catch(function(){
			ok(false, "Login failed");
			start();
		});

	stop();
	iL.Login("tutor", "")
		.then(function(){
			ok(false, "Invalid login allowed");
			start();
		})
		.catch(function(){
			ok(true, "Invalid login blocked");
			start();
		});
});
asyncTest("Tutor", function(){
	expect(3);
	
	iL.Tutor.all()
		.then(function(tutors){
			ok(tutors.length, "Get all Tutors");
			start();
		})
		.catch(function(){
			ok(false, "Getting Tutors failed");
			start();
		});

	stop();
	iL.Tutor.all().then(function(){
		var tutor = iL.Tutor.get(3639);
		ok(!!tutor.name, "Get Tutor (" + tutor.name + ")");
		start();


		ok(iL.Tutor.find("Iain MacDonald"), 'Tutor.find("Iain MacDonald")');
	});
});
asyncTest("Room", function(){
	expect(3);

	iL.Room.all()
		.then(function(rooms){
			ok(rooms.length, "Get all Rooms");
			start();
		})
		.catch(function(){
			ok(false, "Getting Rooms failed");
			start();
		});

	stop();
	iL.Room.all().then(function(){
		var room = iL.Room.get(1);
		ok(!!room.name, "Get Room (" + room.name + ")");
		start();

		ok(iL.Room.find("Room 1"), 'Room.find("Room 1")');
	});
});
asyncTest("Lesson", function(){
	expect(8);

	iL.Lesson.find()
		.then(function(lessons){
			ok(lessons.length, "Lesson.find(): " + lessons.length);
			start();
		})
		.catch(function(){
			ok(false, "Lesson.find()");
			start();
		});

	stop();
	iL.Lesson.find({
		start: new Date("2014-03-19")
	}).then(function(lessons){
		ok(lessons.length, "Lesson.find({start: Date}): " + lessons.length);
		start();
	}).catch(function(){
		ok(false, "Lesson.find({start: Date})");
		start();
	});

	stop();
	iL.Lesson.find({
		tutor: {id: 3639}
	}).then(function(lessons){
		ok(lessons.length, "Lesson.find({tutor: {id: 3639}}): " + lessons.length);
		start();
	}).catch(function(){
		ok(false, "Lesson.find({tutor: {id: 3639}})");
		start();
	});

	stop();
	iL.Lesson.find().then(function(lessons){
		start();

		var lesson = lessons[0];

		ok(iL.Lesson.get(35061).id == 35061, "Lesson.get(35061): [" + lesson.id + ']');

		stop();
		iL.Lesson.find(lesson, "next")
			.then(function(_){
				ok(_.length == 1, 'Lesson.find(lesson, "next"): [' + _[0].id + ']');
				start();
			})
			.catch(function(){
				ok(false, 'Lesson.find(lesson, "next")');
				start();
			});

		stop();
		iL.Lesson.find(lesson, "previous")
			.then(function(_){
				ok(_.length == 1, 'Lesson.find(lesson, "previous"): [' + _[0].id + ']');
				start();
			})
			.catch(function(){
				ok(false, 'Lesson.find(lesson, "previous")');
				start();
			});

		stop();
		iL.Lesson.find(lesson, "past")
			.then(function(_){
				ok(_.length, 'Lesson.find(lesson, "past"): ' + _.length);
				start();
			})
			.catch(function(){
				ok(false, 'Lesson.find(lesson, "past")');
				start();
			});

		stop();
		iL.Lesson.find(lesson, "future")
			.then(function(_){
				ok(_.length, 'Lesson.find(lesson, "future"): ' + _.length);
				start();
			})
			.catch(function(){
				ok(false, 'Lesson.find(lesson, "future")');
				start();
			});

	}).catch(function(){
		start();
	});
});
asyncTest("Big Chain", function(){
	function testChain(a,b,c){
		iL.Tutor.all().then(function(tutors){
			console.log(tutors[a].name + ":");
			return iL.Report.find({tutor:tutors[a]});
		})
		.then(function(reports){
			console.log(reports[b].course.title);
			return iL.Course.lessons(reports[b].course);
		})
		.then(function(lessons){
			console.log("on " + lessons[c].start.getDate() + "/" + (lessons[c].start.getMonth() + 1));
			return iL.Lesson.students(lessons[c]);
		})
		.then(function(students){
			students.map(function(s){console.log("- " + s.englishName)});
			ok(true, "Completed the chain");
			start();
		})
		.catch(function(err){
			console.log("Error occured: " + err.stack);
			ok(false, "Broken chain");
			start();
		});
	}

	expect(1);
	
	testChain(4,1,0);
});
</script>
<div id="qunit"></div>